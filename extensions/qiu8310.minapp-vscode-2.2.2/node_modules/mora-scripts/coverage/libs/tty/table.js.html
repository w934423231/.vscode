<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for libs/tty/table.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">All files</a> / <a href="index.html">libs/tty</a> table.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>114/114</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>37/37</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>22/22</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>108/108</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">39x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33x</span>
<span class="cline-any cline-yes">156x</span>
<span class="cline-any cline-yes">156x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33x</span>
<span class="cline-any cline-yes">33x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">16x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">156x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">156x</span>
<span class="cline-any cline-yes">9x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">156x</span>
<span class="cline-any cline-yes">175x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">156x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33x</span>
<span class="cline-any cline-yes">58x</span>
<span class="cline-any cline-yes">67x</span>
<span class="cline-any cline-yes">67x</span>
<span class="cline-any cline-yes">175x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">67x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">13x</span>
<span class="cline-any cline-yes">13x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">13x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13x</span>
<span class="cline-any cline-yes">13x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">156x</span>
<span class="cline-any cline-yes">156x</span>
<span class="cline-any cline-yes">156x</span>
<span class="cline-any cline-yes">175x</span>
<span class="cline-any cline-yes">175x</span>
<span class="cline-any cline-yes">367x</span>
<span class="cline-any cline-yes">367x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">175x</span>
<span class="cline-any cline-yes">175x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">156x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">105x</span>
<span class="cline-any cline-yes">105x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">105x</span>
<span class="cline-any cline-yes">181x</span>
<span class="cline-any cline-yes">484x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33x</span>
<span class="cline-any cline-yes">33x</span>
<span class="cline-any cline-yes">156x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">156x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">175x</span>
<span class="cline-any cline-yes">60x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33x</span>
<span class="cline-any cline-yes">82x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">14x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * @module      libs/tty/table
 * @createdAt   2016-07-19
 *
 * @copyright   Copyright (c) 2016 Zhonglei Qiu
 * @license     Licensed under the MIT license.
 */
&nbsp;
var punycode = require('punycode')
var os = require('os')
var cliTextSize = require('./cliTextSize')
var greAnsi = require('./stripAnsi').gre
&nbsp;
var encode = punycode.ucs2.encode
var decode = punycode.ucs2.decode
&nbsp;
// 获取当前屏幕的宽度
var stream = process.stdout
var MIN_OVERFLOW_CELL_WIDTH = 10
var SCREEN_WIDTH = 120
&nbsp;
/* istanbul ignore else */
if (stream.getWindowSize &amp;&amp; !process.env.CI) SCREEN_WIDTH = stream.getWindowSize()[0] // 在 CI 中以 120 为准，travis 中只有 32，导致很多输出断行了，很多测试失败
&nbsp;
/**
 * 将一个二维的字符串数组，转化成一个 table 格式的字符串，方便在终端上显示，主要特点有：
 *
 * 1. 精确计算字符的宽度，自动换行：很多老外写的类似的库都采用 str.length 来得到字符串在终端上的显示长度，
 *    但是，中文在终端上一般占用两个字符，而且不同系统上字符长度也会不一样
 * 2. 自动重置颜色：当一个 cell 中有颜色时，如果不重置色值，它是会影响后面 cell 的
 * 3. 判断是否超出屏幕大小：如果超出，自动截断最宽的一行
 *
 * @param  {Array&lt;Array&lt;String&gt;&gt;} rows  table 中每个 cell 中的字符串，是个二维的字符串数组
 * @return {String}               table 化的字符串
 *
 * @example
 *
 * table([
 *   ['a', 'b', 'c'],
 *   ['d', 'ee', 'f']
 * ])
 *
 * // ab c
 * // deef
 *
 * @see [tty-wrap@0.1.0]{@link https://github.com/qiu8310/tty-wrap/tree/0.1.0}
 * @since  2.0.0
 * @author Zhonglei Qiu
 */
module.exports = function(rows) {
  if (!Array.isArray(rows) || !Array.isArray(rows[0]) || !rows[0].length) return ''
&nbsp;
  var maxCellHeights = new Array(rows.length)  // 同一行中， cell 占位最多的高度
&nbsp;
  // 初始化
  each(rows, function(val, opt) {
    rows[opt.r][opt.c] = val = val.replace(/[\r\v\f]/g, '').replace(/\t/g, '    ').split(/\n/)
    maxCellHeights[opt.r] = Math.max(maxCellHeights[opt.r] || 0, val.length)
  })
&nbsp;
  var maxColumnWidths = getMaxWidthsOfEachColumn(rows)
  var sumwidth = sum(maxColumnWidths)
&nbsp;
  // 处理宽度最宽的一列的宽度（不能超过屏幕）
  if (sumwidth &gt; SCREEN_WIDTH) {
    var maxindex = maxNumberIndex(maxColumnWidths)
    var limit = Math.max(MIN_OVERFLOW_CELL_WIDTH, SCREEN_WIDTH - (sumwidth - maxColumnWidths[maxindex])) // 保证不要小于 0
    maxColumnWidths[maxindex] = limit
    each(rows, function(val, opt) {
      if (opt.c === maxindex) {
        rows[opt.r][opt.c] = val = wrapCell(val, limit)
        maxCellHeights[opt.r] = Math.max(maxCellHeights[opt.r], val.length)
      }
    })
  }
&nbsp;
  // 保证每个 cell 的宽度和高度一致
  each(rows, function(val, opt) {
    var i
    var l = val.length
&nbsp;
    // 统一高度
    for (i = 0; i &lt; maxCellHeights[opt.r] - l; i++) {
      val.push('')
    }
&nbsp;
    // 统一宽度
    val.forEach(function(str, j) {
      val[j] = str + space(maxColumnWidths[opt.c] - cliTextSize(str))
    })
&nbsp;
    // 保证 cli 上的颜色不要互相污染
    rows[opt.r][opt.c] = wrapColor(val)
  })
&nbsp;
  // 组装
  var r, c, j, row
  var result = []
&nbsp;
  for (r = 0; r &lt; rows.length; r++) {
    for (j = 0; j &lt; maxCellHeights[r]; j++) {
      row = []
      for (c = 0; c &lt; rows[r].length; c++) {
        row.push(rows[r][c][j])
      }
      result.push(row.join(''))
    }
  }
&nbsp;
  return result.join(os.EOL)
}
&nbsp;
// 限制 cell 的宽度，过长就将它裁断
function wrapCell(cell, size) {
  var res = []
  cell.forEach(function(str) {
    if (cliTextSize(str) &gt; size) {
      res.push.apply(res, wrapStr(str, size))
    } else {
      res.push(str)
    }
  })
  return res
}
&nbsp;
// 限制 string 的宽度，过长就将它裁断
function wrapStr(str, size) {
  var rows = []
  var ansis = []
&nbsp;
  // str 中可能包含 ansi 控制字符
  // 要先备份其位置
  str = str.replace(greAnsi, function(ansi, i) {
    ansis.push([i, ansi])
    return ''
  })
&nbsp;
  var data = []
  var cps = decode(str)
&nbsp;
  cps.forEach(function(cp, i) {
    var char = encode([cp])
    data.push({
      char: char,
      size: cliTextSize(char)
    })
  })
&nbsp;
  var i, ansi, ai
  var len = 0
  var fetchAnsi = function() {
    var t = ansis.shift()
    ai = t &amp;&amp; t[0]
    ansi = t &amp;&amp; t[1]
  }
&nbsp;
  str = ''
  fetchAnsi()
  for (i = 0; i &lt; data.length; i++) {
    if (len + data[i].size &gt; size) {
      rows.push(str)
      str = ''
      len = 0
    }
    if (ansi &amp;&amp; ai === i) {
      str += ansi
      fetchAnsi()
    }
    str += data[i].char
    len += data[i].size
  }
&nbsp;
  /* istanbul ignore else */
  if (str) rows.push(str)
  if (ansi) rows[rows.length - 1] += ansi
  return rows
}
&nbsp;
// 保证 cli 上的颜色不要互相污染
function wrapColor(cell) {
  var hasAnsi
  var stack = ''
  var res = []
  cell.forEach(function(str) {
    var prevStack = stack
    str.replace(greAnsi, function(ansi) {
      hasAnsi = true
      stack += ansi
    })
    if (hasAnsi) str += '\x1b[0m'
    res.push(prevStack + str)
  })
  return res
}
&nbsp;
function each(data, fn) {
  var r, c
  var rowSize = data.length
  var colSize = data[0].length
&nbsp;
  for (r = 0; r &lt; rowSize; r++) {
    for (c = 0; c &lt; colSize; c++) {
      fn(data[r][c], {r: r, c: c})
    }
  }
}
&nbsp;
// 获取每列中宽度最大的值
function getMaxWidthsOfEachColumn(rows) {
  var result = new Array(rows[0].length)
  each(rows, function(cell, opt) {
    result[opt.c] = Math.max(result[opt.c] || 0, getCellWidth(cell))
  })
  return result
}
&nbsp;
function getCellWidth(cell) {
  return Math.max.apply(Math, cell.map(cliTextSize))
}
&nbsp;
function space(n) {
  if (n &lt; 1) return ''
  return new Array(n + 1).join(' ')
}
&nbsp;
function sum(arr) {
  return arr.reduce(function(s, i) {
    return s + i
  }, 0)
}
&nbsp;
function maxNumberIndex(arr) {
  var i
  var max = 0
  var res = -1
  for (i = 0; i &lt; arr.length; i++) {
    if (arr[i] &gt;= max) { // 优先取最后的最大值
      max = arr[i]
      res = i
    }
  }
  return res
}
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Sat May 25 2019 18:05:23 GMT+0800 (CST)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
